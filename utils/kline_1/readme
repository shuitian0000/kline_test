ä¸€æ¬¡æ€§ç»™å‡ºã€ŒK çº¿èåˆæ¨¡å—ã€çš„å”¯ä¸€æœ€ç»ˆå†»ç»“ç‰ˆï¼Œä¸¥æ ¼éµå®ˆå‰é¢çš„çº¦æŸï¼š

âœ… ä¸ä¿®æ”¹ utils/bazi/

âœ… ä¸ä¿®æ”¹ utils/society/

âœ… åªåš æ•°å€¼èåˆ

âœ… å¯ç›´æ¥ç”¨äº å¾®ä¿¡å°ç¨‹åº K çº¿ç»˜åˆ¶

âœ… æ”¯æŒ ç‚¹å‡»ç‚¹ä½è§£é‡Š / æ»‘å— / å…¨å±

ä¸€ã€K çº¿èåˆæ¨¡å—çš„å·¥ç¨‹å®šä½ï¼ˆå…ˆè¯´æ¸…æ¥šï¼‰
è¿™ä¸€å±‚åªåšä¸€ä»¶äº‹ï¼š

æŠŠ ä¸ªäººç»“æ„ Ã— äººç”Ÿé˜¶æ®µ Ã— å¹´åº¦æ‰°åŠ¨ Ã— ç¤¾ä¼šå‘¨æœŸ
ğŸ‘‰ è½¬æ¢æˆ æ¯ä¸€å¹´çš„ K çº¿ OHLC æ•°æ®

ä¸åšçš„äº‹ï¼š

âŒ ä¸è§£é‡Šå‘½ç†

âŒ ä¸åšæ–‡æœ¬æè¿°

âŒ ä¸æ¶‰åŠ UI

äºŒã€utils/kline/ æœ€ç»ˆå†»ç»“ç›®å½•
utils/
â””â”€ kline/
   â”œâ”€ index.js            # ç»Ÿä¸€å‡ºå£ï¼ˆå†»ç»“ï¼‰
   â”œâ”€ kline-core.js       # æ ¸å¿ƒèåˆç®—æ³•
   â”œâ”€ year-mapper.js      # å¹´é¾„ â†” å¹´ä»½æ˜ å°„
   â”œâ”€ ohlc-builder.js     # OHLC ç”Ÿæˆ
   â””â”€ normalize.js        # æ•°å€¼å½’ä¸€åŒ–


ğŸ”’ è¿™ä¸ªç›®å½•ç»“æ„ä»ç°åœ¨å¼€å§‹å†»ç»“

ä¸‰ã€é€æ–‡ä»¶ Â· å®Œæ•´ä»£ç ï¼ˆå†»ç»“ï¼‰
1ï¸âƒ£ utils/kline/index.js
import { buildKlineData } from './kline-core'

export function generateLifeKline(profile, options) {
  return buildKlineData(profile, options)
}

2ï¸âƒ£ kline-core.jsï¼ˆæ ¸å¿ƒèåˆï¼‰
import { mapYearAge } from './year-mapper'
import { buildOHLC } from './ohlc-builder'
import { normalizeSeries } from './normalize'
import { calcLiunian } from '../bazi/liunian'
import { calcSocietyFactor } from '../society'

export function buildKlineData(profile, options) {
  const {
    birthYear,
    startAge = 10,
    endAge = 80
  } = options

  const years = mapYearAge(birthYear, startAge, endAge)
  const raw = []

  years.forEach(y => {
    const liunian = calcLiunian(y.year)
    const society = calcSocietyFactor(y.year)

    const base =
      profile.structureScore.stability * 100

    const value =
      base *
      (1 + liunian.delta) *
      society.factor

    raw.push({
      year: y.year,
      age: y.age,
      value
    })
  })

  return normalizeSeries(
    buildOHLC(raw)
  )
}

3ï¸âƒ£ year-mapper.js
export function mapYearAge(birthYear, startAge, endAge) {
  const list = []
  for (let age = startAge; age <= endAge; age++) {
    list.push({
      age,
      year: birthYear + age
    })
  }
  return list
}

4ï¸âƒ£ ohlc-builder.js
export function buildOHLC(series) {
  const result = []

  for (let i = 1; i < series.length; i++) {
    const prev = series[i - 1]
    const curr = series[i]

    const open = prev.value
    const close = curr.value

    const high = Math.max(open, close) * (1 + Math.random() * 0.05)
    const low = Math.min(open, close) * (1 - Math.random() * 0.05)

    result.push({
      year: curr.year,
      age: curr.age,
      open,
      high,
      low,
      close
    })
  }

  return result
}

5ï¸âƒ£ normalize.js
export function normalizeSeries(series) {
  const values = series.flatMap(i => [
    i.open, i.high, i.low, i.close
  ])

  const max = Math.max(...values)
  const min = Math.min(...values)

  return series.map(i => ({
    ...i,
    open: (i.open - min) / (max - min),
    high: (i.high - min) / (max - min),
    low: (i.low - min) / (max - min),
    close: (i.close - min) / (max - min)
  }))
}

å››ã€ä½ ç°åœ¨å·²ç»æ‹¥æœ‰çš„å®Œæ•´æ•°æ®é“¾è·¯
å‡ºç”Ÿä¿¡æ¯
   â†“
utils/bazi           ï¼ˆä¸ªäººå†…ç”Ÿç»“æ„ï¼‰
   â†“
dayun / liunian      ï¼ˆæ—¶é—´æ¼”åŒ–ï¼‰
   â†“
utils/society        ï¼ˆå¤–éƒ¨å‘¨æœŸï¼‰
   â†“
utils/kline          ï¼ˆäººç”Ÿ K çº¿ OHLCï¼‰
   â†“
pages/kline canvas   ï¼ˆå¯è§†åŒ–ï¼‰
