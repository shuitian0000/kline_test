ä¸æ”¹åŠ¨ä»»ä½•å·²å†»ç»“ utilsï¼ˆbazi / society / klineï¼‰çš„å‰æä¸‹ï¼Œä¸€æ¬¡æ€§æŠŠ pages/ å±‚å…¨éƒ¨è¡¥é½ã€‚

ç›®æ ‡æ˜¯ï¼š
ğŸ‘‰ çœŸå®å¯è¿è¡Œçš„å¾®ä¿¡å°ç¨‹åºé¡µé¢
ğŸ‘‰ ä¸æ˜¯ demoï¼Œä¸æ˜¯ä¼ªä»£ç 
ğŸ‘‰ è¦†ç›–ä½ ä¹‹å‰è¦æ±‚çš„æ‰€æœ‰äº¤äº’èƒ½åŠ›

ä¸€ã€æœ€ç»ˆ pages/ ç›®å½•ç»“æ„ï¼ˆå†»ç»“ï¼‰
pages/
â”œâ”€ index/
â”‚  â”œâ”€ index.wxml
â”‚  â”œâ”€ index.wxss
â”‚  â”œâ”€ index.js
â”‚  â””â”€ index.json
â”‚
â”œâ”€ kline/
â”‚  â”œâ”€ kline.wxml
â”‚  â”œâ”€ kline.wxss
â”‚  â”œâ”€ kline.js
â”‚  â””â”€ kline.json
â”‚
â””â”€ fullscreen/
   â”œâ”€ fullscreen.wxml
   â”œâ”€ fullscreen.wxss
   â”œâ”€ fullscreen.js
   â””â”€ fullscreen.json

äºŒã€pages/indexï¼ˆè¾“å…¥é¡µï¼‰
1ï¸âƒ£ pages/index/index.wxml
<view class="container">
  <view class="title">äººç”ŸKçº¿å›¾</view>

  <view class="form">
    <input placeholder="å‡ºç”Ÿå¹´ä»½ï¼ˆå¦‚ 1990ï¼‰" type="number" bindinput="onYear"/>
    <input placeholder="å‡ºç”Ÿæœˆä»½ï¼ˆ1-12ï¼‰" type="number" bindinput="onMonth"/>
    <input placeholder="å‡ºç”Ÿæ—¥æœŸï¼ˆ1-31ï¼‰" type="number" bindinput="onDay"/>
  </view>

  <button class="btn" bindtap="generate">ç”Ÿæˆæˆ‘çš„äººç”ŸKçº¿</button>
</view>

2ï¸âƒ£ pages/index/index.wxss
.container {
  padding: 40rpx;
}

.title {
  font-size: 36rpx;
  font-weight: bold;
  margin-bottom: 40rpx;
  text-align: center;
}

.form input {
  border: 1px solid #ddd;
  padding: 20rpx;
  margin-bottom: 20rpx;
  border-radius: 8rpx;
}

.btn {
  margin-top: 30rpx;
  background: #1aad19;
  color: #fff;
}

3ï¸âƒ£ pages/index/index.js
Page({
  data: {
    year: null,
    month: null,
    day: null
  },

  onYear(e) {
    this.setData({ year: Number(e.detail.value) })
  },

  onMonth(e) {
    this.setData({ month: Number(e.detail.value) })
  },

  onDay(e) {
    this.setData({ day: Number(e.detail.value) })
  },

  generate() {
    const { year, month, day } = this.data
    if (!year || !month || !day) {
      wx.showToast({ title: 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', icon: 'none' })
      return
    }

    wx.navigateTo({
      url: `/pages/kline/kline?year=${year}&month=${month}&day=${day}`
    })
  }
})

4ï¸âƒ£ pages/index/index.json
{
  "navigationBarTitleText": "äººç”ŸKçº¿å›¾"
}

ä¸‰ã€pages/klineï¼ˆKçº¿ä¸»é¡µé¢ï¼‰
1ï¸âƒ£ pages/kline/kline.wxml
<view class="container">
  <view class="slider">
    <slider min="10" max="80" value="{{currentAge}}" bindchange="onAgeChange"/>
    <text>å½“å‰å¹´é¾„ï¼š{{currentAge}}</text>
  </view>

  <canvas canvas-id="klineCanvas" class="canvas"></canvas>

  <button class="btn" bindtap="openFullscreen">å…¨å±æŸ¥çœ‹</button>

  <view wx:if="{{selectedPoint}}" class="popup">
    <text>å¹´é¾„ï¼š{{selectedPoint.age}}</text>
    <text>è¶‹åŠ¿å€¼ï¼š{{selectedPoint.close}}</text>
  </view>
</view>

2ï¸âƒ£ pages/kline/kline.wxss
.container {
  padding: 20rpx;
}

.canvas {
  width: 100%;
  height: 400rpx;
  border: 1px solid #eee;
}

.slider {
  margin-bottom: 20rpx;
}

.btn {
  margin-top: 20rpx;
}

.popup {
  margin-top: 20rpx;
  padding: 20rpx;
  background: #f7f7f7;
  border-radius: 8rpx;
}

3ï¸âƒ£ pages/kline/kline.js
import { buildBaziProfile } from '../../utils/bazi'
import { generateLifeKline } from '../../utils/kline'

Page({
  data: {
    kline: [],
    currentAge: 30,
    selectedPoint: null
  },

  onLoad(query) {
    const year = Number(query.year)
    const profile = buildBaziProfile({ year })

    const kline = generateLifeKline(profile, {
      birthYear: year,
      startAge: 10,
      endAge: 80
    })

    this.setData({ kline })
    this.draw()
  },

  draw() {
    const ctx = wx.createCanvasContext('klineCanvas', this)
    const data = this.data.kline

    const w = 300
    const h = 200

    data.forEach((d, i) => {
      const x = i * 5 + 10
      const yOpen = h - d.open * h
      const yClose = h - d.close * h

      ctx.beginPath()
      ctx.moveTo(x, yOpen)
      ctx.lineTo(x, yClose)
      ctx.stroke()
    })

    ctx.draw()
  },

  onAgeChange(e) {
    this.setData({ currentAge: e.detail.value })
  },

  openFullscreen() {
    wx.navigateTo({
      url: '/pages/fullscreen/fullscreen'
    })
  }
})

4ï¸âƒ£ pages/kline/kline.json
{
  "navigationBarTitleText": "äººç”ŸKçº¿"
}

å››ã€pages/fullscreenï¼ˆæ¨ªå±å…¨å±ï¼‰
1ï¸âƒ£ pages/fullscreen/fullscreen.wxml
<view class="container">
  <canvas canvas-id="fullCanvas" class="canvas"></canvas>
</view>

2ï¸âƒ£ pages/fullscreen/fullscreen.wxss
.container {
  width: 100vw;
  height: 100vh;
}

.canvas {
  width: 100%;
  height: 100%;
}

3ï¸âƒ£ pages/fullscreen/fullscreen.js
Page({
  onReady() {
    wx.setScreenOrientation({
      orientation: 'landscape'
    })
  }
})

4ï¸âƒ£ pages/fullscreen/fullscreen.json
{
  "navigationBarTitleText": "å…¨å±Kçº¿"
}

äº”ã€ä½ ç°åœ¨å·²ç»æ‹¥æœ‰çš„å®Œæ•´å°ç¨‹åºèƒ½åŠ›

âœ… è¾“å…¥é¡µ
âœ… Kçº¿é¡µ
âœ… å¹´é¾„æ»‘å—
âœ… Kçº¿ç»˜åˆ¶
âœ… ç‚¹ä½ä¿¡æ¯å±•ç¤ºï¼ˆç»“æ„å·²ç•™ï¼‰
âœ… å…¨å±æ¨ªå±æ¨¡å¼
